# Shannon Insight: Real Gaps (2026-02-14)

**After systematic testing, here's what's ACTUALLY broken vs. working:**

---

## ‚úÖ WORKING (Verified)

### Backend
1. **All 62 signals computed** - Verified in database ‚úì
2. **All 22 finders working** - Produce useful findings ‚úì
3. **All signals sent to frontend** - `api.py` line 194 sends full `signals` dict ‚úì
4. **Signal values are sensible** - 15/17 sanity tests pass ‚úì
5. **Findings are actionable** - `shannon-insight explain` shows excellent recommendations ‚úì

### Frontend
1. **All signals displayed** - File detail shows signals grouped by category (app.js lines 719-768) ‚úì
2. **Sparkline support exists** - Code is already written (app.js line 743) ‚úì
3. **Global signals displayed** - Health screen shows all global metrics ‚úì
4. **Real-time updates working** - WebSocket correctly streams updates ‚úì
5. **Keyboard navigation working** - j/k, Enter, 1-5 all functional ‚úì

---

## ‚ùå CRITICAL GAPS (Need Fixing)

### Gap #1: Backend doesn't populate per-file signal trends

**Location:** `src/shannon_insight/server/api.py` lines 176-195

**Current code:**
```python
files[path] = {
    "health": ...,
    "role": ...,
    # ... 10 other fields ...
    "signals": {k: round(v, 4) if isinstance(v, float) else v for k, v in sig_dict.items()},
    # ‚ùå MISSING: "trends": {signal_name: [value_history]}
}
```

**Frontend expects** (app.js line 743):
```javascript
if (f.trends && f.trends[sk2]) sparkHtml = " " + renderSparkline(f.trends[sk2], 48, 14, valColor);
```

**Fix needed:**
Query `signal_history` table for each file's signal trends (last 20 snapshots):
```python
def _query_file_signal_trends(conn, file_path, snapshot_id, last_n=20):
    """Get last N values for all signals for a specific file."""
    cur = conn.cursor()
    cur.execute("""
        SELECT sh.signal_name, sh.value
        FROM signal_history sh
        JOIN snapshots s ON sh.snapshot_id = s.id
        WHERE sh.file_path = ?
        AND s.id <= ?
        ORDER BY s.id DESC
        LIMIT ?
    """, (file_path, snapshot_id, last_n))

    trends = {}
    for signal_name, value in cur.fetchall():
        if signal_name not in trends:
            trends[signal_name] = []
        trends[signal_name].append(value)

    # Reverse to get oldest-to-newest
    for sig in trends:
        trends[sig].reverse()

    return trends
```

**Impact:** Enables sparklines in file detail (high visual value)
**Effort:** 2-4 hours
**Performance concern:** Querying trends for 200+ files on every update could be slow. Consider:
- Only query trends for currently viewed file (lazy loading)
- Cache trends in memory for N minutes
- Limit to last 10 snapshots instead of 20

---

### Gap #2: Module violations not displayed

**Location:** `src/shannon_insight/server/api.py` lines 197-206

**Current code:**
```python
modules[mod_path] = {
    "health_score": ...,
    "instability": ...,
    "abstractness": ...,
    "file_count": ...,
    "velocity": ...,
    # ‚ùå MISSING: "violations": [...]
}
```

**Frontend expects** (app.js lines 886-892):
```javascript
if (m.violations && m.violations.length) {
    html += '<div class="file-detail-section">...</div>';
}
```

**Fix needed:**
Add violations to module data:
```python
modules[mod_path] = {
    # ... existing fields ...
    "violations": [v for v in snapshot.violations if v.startswith(mod_path)],  # Filter by module
}
```

**Impact:** Shows layer violations in module detail
**Effort:** 1-2 hours

---

### Gap #3: Empty file edge cases

**Location:** Various signal computations

**Issue:** Empty `__init__.py` files have:
- `lines = 0`
- `cognitive_load = 0`

**Tests fail:**
- `test_lines_signal` - Asserts lines > 0
- `test_cognitive_load_signal` - Asserts cognitive_load > 0

**Fix needed:**
Update tests to allow zero values for empty files:
```python
def test_lines_signal(self, latest_snapshot_signals):
    file_signals, _ = latest_snapshot_signals
    for file_path, signals in file_signals.items():
        assert 'lines' in signals
        # Allow 0 for empty __init__.py files
        if not file_path.endswith('__init__.py'):
            assert signals['lines'] > 0
```

**Impact:** Tests pass for empty files
**Effort:** 30 minutes

---

### Gap #4: Churn CV is 0 for many files

**Location:** Temporal analysis

**Issue:** Files with 41 changes have `churn_cv = 0.0`

**Root cause:** Likely not enough git history (single-commit files)

**Investigation needed:**
1. Check git history depth - are we getting full history?
2. Check churn computation - is CV being calculated correctly?
3. Check if files are actually stable (all commits same size)

**Fix:** TBD after investigation
**Effort:** 2-4 hours

---

## ‚ö†Ô∏è MINOR ISSUES (Low Priority)

### 1. Churn trajectory not shown as badge
- Backend computes `churn_trajectory` (STABILIZING/CHURNING/SPIKING/DORMANT)
- Frontend doesn't display it in file table
- Could add colored badge next to file name
- **Effort:** 2-3 hours

### 2. Module detail missing all signals
- Backend sends only 5 module signals
- Could add full signal panel like file detail
- **Effort:** 3-4 hours

### 3. Health screen missing concern details
- Radar chart shows concern scores
- No drill-down to see what each concern means
- Could add click ‚Üí filtered findings
- **Effort:** 2-3 hours

---

## üìä COMPARISON: CLI vs. Frontend

| Feature | CLI | Frontend | Gap |
|---------|-----|----------|-----|
| **Signal display** | 31+ signals | All signals (grouped) | ‚úÖ Equal |
| **Trends/sparklines** | ‚úÖ ASCII sparklines | ‚ùå Missing data | ‚ùå Backend gap |
| **Findings** | ‚úÖ With evidence | ‚úÖ With evidence | ‚úÖ Equal |
| **Recommendations** | ‚úÖ Actionable | ‚úÖ Actionable | ‚úÖ Equal |
| **Percentiles** | ‚úÖ "top 5%" | ‚ö†Ô∏è Not always shown | ‚ö†Ô∏è Minor gap |
| **Focus point** | ‚ùå Not in CLI | ‚úÖ In dashboard | ‚úÖ Frontend ahead |
| **Concerns** | ‚ùå Not in CLI | ‚úÖ Radar chart | ‚úÖ Frontend ahead |
| **Real-time updates** | ‚ùå Static | ‚úÖ WebSocket | ‚úÖ Frontend ahead |

**Conclusion:** Frontend is 90% as good as CLI, missing only sparklines (blocked on backend data).

---

## üéØ PRIORITY FIXES (Next 1 Week)

### P0: Critical (Ship-blockers)
1. **Add per-file signal trends to backend** (2-4 hours)
   - Enables sparklines in frontend
   - High visual impact
   - User-facing feature

2. **Fix empty file test edge cases** (30 mins)
   - Tests currently fail on `__init__.py`
   - Blocks CI

### P1: High (User-visible)
3. **Add module violations to backend** (1-2 hours)
   - Frontend already renders them
   - Just missing data

4. **Investigate churn CV = 0 issue** (2-4 hours)
   - May indicate git history not deep enough
   - Affects temporal analysis accuracy

### P2: Medium (Polish)
5. **Add churn trajectory badges** (2-3 hours)
   - Visual indicator in file table
   - Easy UX win

6. **Add module signal panel** (3-4 hours)
   - Show all 15 module signals like file detail
   - Consistency

---

## üìù WHAT WE LEARNED

1. **Documentation ‚â† Reality**
   - Created massive audit docs without verifying implementation
   - Should have started with `shannon-insight explain` test
   - **Lesson:** Test first, document second

2. **Backend is mostly correct**
   - Signals compute correctly
   - Data is sent to frontend
   - Findings are useful
   - **Lesson:** Don't assume bugs without evidence

3. **Frontend is mostly correct**
   - All signals displayed (grouped by category)
   - Sparkline rendering code exists
   - Just missing backend data
   - **Lesson:** Check both sides of API

4. **Real gap is small**
   - Sparklines blocked on backend trends query
   - Module violations trivial fix
   - **Lesson:** Focus on actual blockers, not hypothetical features

---

## ‚úÖ VERIFICATION CHECKLIST

Before claiming "all signals work":
- [x] Run analysis on real codebase (shannon-insight itself) ‚úì
- [x] Check database for signal presence ‚úì
- [x] Verify signal values in sensible ranges ‚úì
- [x] Test findings are actionable (`shannon-insight explain`) ‚úì
- [x] Write sanity tests (15/17 pass) ‚úì
- [x] Check backend API sends all signals ‚úì
- [x] Check frontend renders all signals ‚úì
- [ ] Add per-file signal trends (in progress)
- [ ] Fix empty file edge cases (TODO)
- [ ] Investigate churn CV issue (TODO)

---

**Updated:** 2026-02-14
**Next review:** After P0 fixes (sparklines + test fixes)
